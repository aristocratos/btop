# GitLab CI/CD Pipeline for btop++
# Builds for macOS (Apple Silicon) and Linux

stages:
  - build
  - test
  - package
  - publish
  - release

variables:
  GIT_DEPTH: 50
  GIT_STRATEGY: fetch
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/btop"

# Default settings
default:
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Cache configuration
.cache_template: &cache_template
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - obj/
    policy: pull-push

# =============================================================================
# macOS Builds (Apple Silicon with GPU support)
# REQUIRES: A runner with shell executor and 'macos-shell' tag
# To register: gitlab-runner register --executor shell --tag-list "macos-shell"
# =============================================================================
.macos_template: &macos_template
  tags:
    - macos-shell
  before_script:
    - export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
    - which brew && brew --version || echo "Homebrew not found"
  <<: *cache_template

build:macos-arm64:
  <<: *macos_template
  stage: build
  script:
    - echo "Building btop++ for macOS ARM64 with Apple Silicon GPU support"
    - make clean || true
    - make -j$(sysctl -n hw.ncpu)
    - ./bin/btop --version || echo "Version check skipped"
    - |
      GIT_HASH=$(git rev-parse --short HEAD)
      ARTIFACT_NAME="btop-macos-arm64-${GIT_HASH}"
      mkdir -p artifacts
      cp bin/btop "artifacts/${ARTIFACT_NAME}"
      cp README.md artifacts/
      cp LICENSE artifacts/
  artifacts:
    name: btop-macos-arm64-${CI_COMMIT_SHORT_SHA}
    paths:
      - artifacts/
      - bin/btop
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

build:macos-arm64-debug:
  <<: *macos_template
  stage: build
  script:
    - echo "Building btop++ DEBUG for macOS ARM64"
    - make clean || true
    - make DEBUG=true -j$(sysctl -n hw.ncpu)
  artifacts:
    name: btop-macos-arm64-debug-${CI_COMMIT_SHORT_SHA}
    paths:
      - bin/btop
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# =============================================================================
# Linux Builds
# =============================================================================

.linux_template: &linux_template
  image: ubuntu:24.04
  tags:
    - docker
  before_script:
    - apt-get update -qq
    # Install GCC 14 for full C++23 support (std::ranges::to)
    - apt-get install -y -qq software-properties-common
    - add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - apt-get update -qq
    - apt-get install -y -qq build-essential g++-14 git lowdown file
    - update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
    - g++ --version
  <<: *cache_template

build:linux-x86_64:
  <<: *linux_template
  stage: build
  script:
    - echo "Building btop++ for Linux x86_64"
    - make clean || true
    - make -j$(nproc)
    - |
      GIT_HASH=$(git rev-parse --short HEAD)
      ARTIFACT_NAME="btop-linux-x86_64-${GIT_HASH}"
      mkdir -p artifacts
      cp bin/btop "artifacts/${ARTIFACT_NAME}"
  artifacts:
    name: btop-linux-x86_64-${CI_COMMIT_SHORT_SHA}
    paths:
      - artifacts/
      - bin/btop
    expire_in: 30 days
  allow_failure: true  # No docker runner available - don't block macOS pipeline
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

build:linux-x86_64-static:
  <<: *linux_template
  stage: build
  script:
    - echo "Building btop++ STATIC for Linux x86_64"
    - make clean || true
    - make STATIC=true -j$(nproc)
    - |
      GIT_HASH=$(git rev-parse --short HEAD)
      ARTIFACT_NAME="btop-linux-x86_64-static-${GIT_HASH}"
      mkdir -p artifacts
      cp bin/btop "artifacts/${ARTIFACT_NAME}"
  artifacts:
    name: btop-linux-x86_64-static-${CI_COMMIT_SHORT_SHA}
    paths:
      - artifacts/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_TAG

# =============================================================================
# Alpine/musl Build (smaller binary)
# =============================================================================

build:linux-alpine:
  image: alpine:latest
  tags:
    - docker
  stage: build
  before_script:
    - apk add --no-cache build-base g++ git coreutils sed lowdown
  script:
    - echo "Building btop++ for Alpine Linux (musl)"
    - make clean || true
    - make STATIC=true -j$(nproc)
    - |
      GIT_HASH=$(git rev-parse --short HEAD)
      mkdir -p artifacts
      cp bin/btop "artifacts/btop-linux-musl-x86_64-${GIT_HASH}"
  artifacts:
    name: btop-linux-musl-${CI_COMMIT_SHORT_SHA}
    paths:
      - artifacts/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_TAG

# =============================================================================
# Test Stage
# =============================================================================

test:macos-smoke:
  <<: *macos_template
  stage: test
  needs:
    - job: build:macos-arm64
      artifacts: true
  script:
    - echo "Running smoke tests on macOS"
    - test -f bin/btop || exit 1
    - file bin/btop
    - ./bin/btop --version
    - ./bin/btop --help
    - echo "Smoke test passed"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

test:linux-smoke:
  <<: *linux_template
  stage: test
  needs:
    - job: build:linux-x86_64
      artifacts: true
  script:
    - echo "Running smoke tests on Linux"
    - test -f bin/btop || exit 1
    - file bin/btop
    - ./bin/btop --version
    - ./bin/btop --help
    - echo "Smoke test passed"
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# =============================================================================
# Package Stage
# =============================================================================

package:tarball:
  image: alpine:latest
  tags:
    - docker
  stage: package
  needs:
    - job: build:macos-arm64
      artifacts: true
      optional: true
    - job: build:linux-x86_64
      artifacts: true
  script:
    - apk add --no-cache tar gzip
    - |
      VERSION=$(grep -oP 'Version = "\K[^"]+' src/btop.cpp || echo "${CI_COMMIT_SHORT_SHA}")
      RELEASE_DIR="btop-${VERSION}"
      mkdir -p "${RELEASE_DIR}"
      cp -r artifacts/* "${RELEASE_DIR}/" 2>/dev/null || true
      cp README.md LICENSE CHANGELOG.md "${RELEASE_DIR}/" 2>/dev/null || true
      cp -r themes "${RELEASE_DIR}/"
      tar -czvf "btop-${VERSION}-${CI_COMMIT_SHORT_SHA}.tar.gz" "${RELEASE_DIR}"
  artifacts:
    name: btop-release-${CI_COMMIT_SHORT_SHA}
    paths:
      - "*.tar.gz"
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"

# =============================================================================
# Publish Stage - Push binaries to GitLab Package Registry
# =============================================================================

publish:binaries:
  image: curlimages/curl:latest
  tags:
    - docker
  stage: publish
  needs:
    - job: build:macos-arm64
      artifacts: true
      optional: true
    - job: build:linux-x86_64
      artifacts: true
  script:
    - |
      # Set version (use tag if available, otherwise commit SHA)
      if [ -n "${CI_COMMIT_TAG}" ]; then
        VERSION="${CI_COMMIT_TAG}"
      else
        VERSION="${CI_COMMIT_SHORT_SHA}"
      fi
      echo "Publishing version: ${VERSION}"
      echo "Package Registry URL: ${PACKAGE_REGISTRY_URL}"

      # Debug: show available artifacts
      echo "=== Available artifacts ==="
      ls -la artifacts/ 2>/dev/null || echo "No artifacts directory found!"

      UPLOADED=0

      # Publish Linux binary
      if [ -d "artifacts" ]; then
        for file in artifacts/btop-linux-*; do
          if [ -f "$file" ]; then
            FILENAME=$(basename "$file")
            echo "Uploading $FILENAME..."
            curl --fail --show-error \
                 --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
                 --upload-file "$file" \
                 "${PACKAGE_REGISTRY_URL}/${VERSION}/${FILENAME}"
            echo " -> Upload complete"
            UPLOADED=$((UPLOADED + 1))
          fi
        done

        # Publish macOS binary if available
        for file in artifacts/btop-macos-*; do
          if [ -f "$file" ]; then
            FILENAME=$(basename "$file")
            echo "Uploading $FILENAME..."
            curl --fail --show-error \
                 --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
                 --upload-file "$file" \
                 "${PACKAGE_REGISTRY_URL}/${VERSION}/${FILENAME}"
            echo " -> Upload complete"
            UPLOADED=$((UPLOADED + 1))
          fi
        done
      fi

      echo "=== Summary ==="
      echo "Uploaded ${UPLOADED} file(s) to: ${CI_PROJECT_URL}/-/packages"
      if [ "$UPLOADED" -eq 0 ]; then
        echo "WARNING: No files were uploaded!"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"

publish:tarball:
  image: curlimages/curl:latest
  tags:
    - docker
  stage: publish
  needs:
    - job: package:tarball
      artifacts: true
  script:
    - |
      # Set version (use tag if available, otherwise commit SHA)
      if [ -n "${CI_COMMIT_TAG}" ]; then
        VERSION="${CI_COMMIT_TAG}"
      else
        VERSION="${CI_COMMIT_SHORT_SHA}"
      fi
      echo "Publishing version: ${VERSION}"

      # Debug: show available tarballs
      echo "=== Available tarballs ==="
      ls -la *.tar.gz 2>/dev/null || echo "No tarballs found!"

      UPLOADED=0

      for file in *.tar.gz; do
        if [ -f "$file" ]; then
          FILENAME=$(basename "$file")
          echo "Uploading $FILENAME..."
          curl --fail --show-error \
               --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
               --upload-file "$file" \
               "${PACKAGE_REGISTRY_URL}/${VERSION}/${FILENAME}"
          echo " -> Upload complete"
          UPLOADED=$((UPLOADED + 1))
        fi
      done

      echo "=== Summary ==="
      echo "Uploaded ${UPLOADED} tarball(s) to: ${CI_PROJECT_URL}/-/packages"
      if [ "$UPLOADED" -eq 0 ]; then
        echo "WARNING: No tarballs were uploaded!"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"

# =============================================================================
# Release Stage
# =============================================================================

release:gitlab:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags:
    - docker
  stage: release
  needs:
    - job: publish:binaries
      artifacts: false
    - job: publish:tarball
      artifacts: false
  script:
    - echo "Creating GitLab release for ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "btop++ ${CI_COMMIT_TAG}"
    description: |
      ## btop++ ${CI_COMMIT_TAG}

      ### Downloads
      Download from the [Package Registry](${CI_PROJECT_URL}/-/packages):
      - **macOS ARM64** (Apple Silicon with GPU support)
      - **Linux x86_64**

      ### Changelog
      See CHANGELOG.md for details.

      ### Installation
      ```bash
      # Download and install
      chmod +x btop-*
      sudo mv btop-* /usr/local/bin/btop
      ```
    assets:
      links:
        - name: "Linux x86_64 Binary"
          url: "${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/btop-linux-x86_64-${CI_COMMIT_SHORT_SHA}"
          link_type: package
        - name: "macOS ARM64 Binary"
          url: "${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/btop-macos-arm64-${CI_COMMIT_SHORT_SHA}"
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG

# =============================================================================
# Scheduled/Manual Jobs
# =============================================================================

build:nightly:
  <<: *macos_template
  stage: build
  script:
    - echo "Nightly build - full clean rebuild"
    - make distclean || true
    - make -j$(sysctl -n hw.ncpu)
    - |
      DATE=$(date +%Y%m%d)
      GIT_HASH=$(git rev-parse --short HEAD)
      mkdir -p artifacts
      cp bin/btop "artifacts/btop-nightly-${DATE}-${GIT_HASH}"
  artifacts:
    name: btop-nightly-${CI_COMMIT_SHORT_SHA}
    paths:
      - artifacts/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# =============================================================================
# Code Quality and Static Analysis
# =============================================================================

lint:cppcheck:
  image: ubuntu:24.04
  tags:
    - docker
  stage: test
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq cppcheck
  script:
    - echo "Running cppcheck static analysis"
    - mkdir -p reports
    - |
      cppcheck \
        --enable=warning,performance,portability \
        --std=c++20 \
        --error-exitcode=1 \
        --suppress=missingIncludeSystem \
        --suppress=unusedFunction \
        --suppress=useStlAlgorithm \
        --inline-suppr \
        --xml \
        --xml-version=2 \
        -DGPU_SUPPORT \
        -I src/ \
        src/ 2> reports/cppcheck-report.xml || CPPCHECK_EXIT=$?
    - |
      # Convert XML to readable format
      cppcheck \
        --enable=warning,performance,portability \
        --std=c++20 \
        --suppress=missingIncludeSystem \
        --suppress=unusedFunction \
        --suppress=useStlAlgorithm \
        --inline-suppr \
        -DGPU_SUPPORT \
        -I src/ \
        src/ 2>&1 | tee reports/cppcheck-report.txt
    - |
      # Fail only on errors, not warnings
      if grep -q "error" reports/cppcheck-report.txt; then
        echo "Static analysis found errors"
        exit 1
      fi
    - echo "Static analysis passed"
  artifacts:
    name: cppcheck-report-${CI_COMMIT_SHORT_SHA}
    paths:
      - reports/
    expire_in: 30 days
    when: always
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

lint:clang-tidy:
  image: ubuntu:24.04
  tags:
    - docker
  stage: test
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq software-properties-common
    - add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - apt-get update -qq
    - apt-get install -y -qq clang-tidy-18 g++-14 build-essential
    - update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-18 100
    - clang-tidy --version
  script:
    - echo "Running clang-tidy static analysis"
    - mkdir -p reports
    - |
      # Create compile_commands.json compatible flags
      COMPILE_FLAGS="-std=c++23 -DFMT_HEADER_ONLY -D_GLIBCXX_ASSERTIONS -DGPU_SUPPORT -I src/"

      # Run clang-tidy on core source files
      clang-tidy \
        --checks='-*,bugprone-*,performance-*,modernize-*,-modernize-use-trailing-return-type,-modernize-avoid-c-arrays' \
        --header-filter='src/.*' \
        -p . \
        src/btop_tools.cpp \
        src/btop_config.cpp \
        src/btop_input.cpp \
        -- ${COMPILE_FLAGS} 2>&1 | tee reports/clang-tidy-report.txt || true
    - |
      # Count issues
      WARNING_COUNT=$(grep -c "warning:" reports/clang-tidy-report.txt || echo "0")
      ERROR_COUNT=$(grep -c "error:" reports/clang-tidy-report.txt || echo "0")
      echo "Warnings: ${WARNING_COUNT}, Errors: ${ERROR_COUNT}"

      # Fail only on errors
      if [ "${ERROR_COUNT}" -gt 0 ]; then
        echo "clang-tidy found errors"
        exit 1
      fi
    - echo "clang-tidy analysis passed"
  artifacts:
    name: clang-tidy-report-${CI_COMMIT_SHORT_SHA}
    paths:
      - reports/
    expire_in: 30 days
    when: always
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# =============================================================================
# Unit Tests
# =============================================================================

test:unit-linux:
  image: ubuntu:24.04
  tags:
    - docker
  stage: test
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq software-properties-common
    - add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - apt-get update -qq
    - apt-get install -y -qq build-essential g++-14 cmake git
    - update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
    - g++ --version
    - cmake --version
  script:
    - echo "Building and running unit tests"
    - mkdir -p build && cd build
    - cmake -DBUILD_TESTING=ON -DCMAKE_CXX_STANDARD=23 ..
    - make -j$(nproc) btop_test || make btop_test
    - |
      # Run tests (use pipefail to capture test exit code through pipe)
      set -o pipefail
      ./tests/btop_test --gtest_output=xml:../reports/test-results.xml 2>&1 | tee ../reports/test-output.txt
  artifacts:
    name: unit-test-results-${CI_COMMIT_SHORT_SHA}
    paths:
      - reports/
    expire_in: 30 days
    when: always
    reports:
      junit: reports/test-results.xml
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

test:unit-macos:
  <<: *macos_template
  stage: test
  script:
    - echo "Building and running unit tests on macOS"
    - which cmake || brew install cmake
    - mkdir -p build && cd build
    - cmake -DBUILD_TESTING=ON -DCMAKE_CXX_STANDARD=23 ..
    - make -j$(sysctl -n hw.ncpu) btop_test || make btop_test
    - |
      # Run tests (use pipefail to capture test exit code through pipe)
      set -o pipefail
      ./tests/btop_test --gtest_output=xml:../reports/test-results.xml 2>&1 | tee ../reports/test-output.txt
  artifacts:
    name: unit-test-macos-results-${CI_COMMIT_SHORT_SHA}
    paths:
      - reports/
    expire_in: 30 days
    when: always
    reports:
      junit: reports/test-results.xml
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "gpu-apple-silicon-nosudo"
    - if: $CI_COMMIT_BRANCH == "apple-silicon-comprehensive-monitoring"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true
